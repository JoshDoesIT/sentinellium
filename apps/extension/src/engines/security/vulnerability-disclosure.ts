/**
 * @module Vulnerability Disclosure
 * @description Vulnerability disclosure program management.
 * Handles report submission, status tracking, and policy display.
 */

/* ── Types ── */

export enum Severity {
  LOW = "low",
  MEDIUM = "medium",
  HIGH = "high",
  CRITICAL = "critical",
}

export type ReportStatus = "open" | "investigating" | "resolved" | "dismissed";

export interface VulnerabilityReport {
  id: string;
  title: string;
  description: string;
  severity: Severity;
  reporter: string;
  status: ReportStatus;
  submittedAt: number;
  updatedAt: number;
}

export interface DisclosurePolicy {
  contactEmail: string;
  pgpKeyUrl?: string;
}

/* ── Helpers ── */

let reportSeq = 0;
function generateReportId(): string {
  reportSeq++;
  return `VD-${reportSeq.toString().padStart(4, "0")}`;
}

/* ── Disclosure ── */

/**
 * Vulnerability disclosure program.
 */
export class VulnerabilityDisclosure {
  private readonly policy: DisclosurePolicy;
  private readonly reports = new Map<string, VulnerabilityReport>();

  constructor(policy: DisclosurePolicy) {
    this.policy = policy;
  }

  /**
   * Submit a vulnerability report.
   *
   * @param input - Report details
   * @returns Report ID
   */
  submit(input: {
    title: string;
    description: string;
    severity: Severity;
    reporter: string;
  }): string {
    const id = generateReportId();
    const now = Date.now();

    this.reports.set(id, {
      id,
      title: input.title,
      description: input.description,
      severity: input.severity,
      reporter: input.reporter,
      status: "open",
      submittedAt: now,
      updatedAt: now,
    });

    return id;
  }

  /**
   * Get a report by ID.
   *
   * @param id - Report ID
   */
  getReport(id: string): VulnerabilityReport | undefined {
    const report = this.reports.get(id);
    return report ? { ...report } : undefined;
  }

  /**
   * Update report status.
   *
   * @param id - Report ID
   * @param status - New status
   */
  updateStatus(id: string, status: ReportStatus): void {
    const report = this.reports.get(id);
    if (!report) throw new Error(`Report '${id}' not found`);
    report.status = status;
    report.updatedAt = Date.now();
  }

  /** Get the disclosure policy. */
  getPolicy(): DisclosurePolicy {
    return { ...this.policy };
  }
}
