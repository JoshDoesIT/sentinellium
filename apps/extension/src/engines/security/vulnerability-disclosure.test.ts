/**
 * @module Vulnerability Disclosure Tests
 * @description TDD tests for vulnerability disclosure program (SECURITY.md).
 */
import { describe, it, expect, beforeEach, vi, afterEach } from "vitest";
import { VulnerabilityDisclosure, Severity } from "./vulnerability-disclosure";

describe("VulnerabilityDisclosure", () => {
  let disclosure: VulnerabilityDisclosure;

  beforeEach(() => {
    vi.useFakeTimers();
    vi.setSystemTime(new Date("2026-01-15T12:00:00Z"));
    disclosure = new VulnerabilityDisclosure({
      contactEmail: "security@sentinellium.com",
      pgpKeyUrl: "https://sentinellium.com/.well-known/pgp-key.txt",
    });
  });

  afterEach(() => {
    vi.useRealTimers();
  });

  describe("submit", () => {
    it("accepts a vulnerability report", () => {
      const id = disclosure.submit({
        title: "XSS in alert dashboard",
        description: "Reflected XSS via alert title parameter",
        severity: Severity.HIGH,
        reporter: "researcher@bugbounty.com",
      });

      expect(id).toBeTruthy();
    });
  });

  describe("getReport", () => {
    it("retrieves a submitted report", () => {
      const id = disclosure.submit({
        title: "CSRF in settings",
        description: "Missing CSRF token on settings form",
        severity: Severity.MEDIUM,
        reporter: "researcher@bugbounty.com",
      });

      const report = disclosure.getReport(id);
      expect(report!.title).toBe("CSRF in settings");
      expect(report!.status).toBe("open");
    });
  });

  describe("updateStatus", () => {
    it("transitions report status", () => {
      const id = disclosure.submit({
        title: "Open redirect",
        description: "Unvalidated redirect in auth flow",
        severity: Severity.LOW,
        reporter: "researcher@bugbounty.com",
      });

      disclosure.updateStatus(id, "investigating");
      expect(disclosure.getReport(id)!.status).toBe("investigating");

      disclosure.updateStatus(id, "resolved");
      expect(disclosure.getReport(id)!.status).toBe("resolved");
    });
  });

  describe("getPolicy", () => {
    it("returns disclosure policy", () => {
      const policy = disclosure.getPolicy();
      expect(policy.contactEmail).toBe("security@sentinellium.com");
      expect(policy.pgpKeyUrl).toBeTruthy();
    });
  });
});
