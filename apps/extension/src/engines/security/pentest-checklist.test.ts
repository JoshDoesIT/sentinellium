/**
 * @module Pen Test Checklist Tests
 * @description TDD tests for penetration testing plan & checklist management.
 */
import { describe, it, expect, beforeEach, vi, afterEach } from "vitest";
import { PenTestChecklist, TestCategory } from "./pentest-checklist";

describe("PenTestChecklist", () => {
  let checklist: PenTestChecklist;

  beforeEach(() => {
    vi.useFakeTimers();
    vi.setSystemTime(new Date("2026-01-15T12:00:00Z"));
    checklist = new PenTestChecklist("Q1 2026 Pen Test");
  });

  afterEach(() => {
    vi.useRealTimers();
  });

  describe("addItem", () => {
    it("adds a test item to the checklist", () => {
      checklist.addItem({
        name: "Test SQL injection on login",
        category: TestCategory.INJECTION,
        priority: "high",
      });

      expect(checklist.getItems()).toHaveLength(1);
      expect(checklist.getItems()[0]!.status).toBe("pending");
    });
  });

  describe("markComplete", () => {
    it("marks an item as complete with findings", () => {
      checklist.addItem({
        name: "Test CSRF protections",
        category: TestCategory.SESSION,
        priority: "medium",
      });

      const items = checklist.getItems();
      checklist.markComplete(items[0]!.id, "CSRF tokens properly validated");

      expect(checklist.getItems()[0]!.status).toBe("complete");
    });
  });

  describe("getProgress", () => {
    it("calculates completion percentage", () => {
      checklist.addItem({
        name: "Test A",
        category: TestCategory.AUTH,
        priority: "high",
      });
      checklist.addItem({
        name: "Test B",
        category: TestCategory.INJECTION,
        priority: "medium",
      });

      const items = checklist.getItems();
      checklist.markComplete(items[0]!.id, "Passed");

      const progress = checklist.getProgress();
      expect(progress.total).toBe(2);
      expect(progress.completed).toBe(1);
      expect(progress.percentage).toBe(50);
    });
  });

  describe("generateReport", () => {
    it("produces a summary report", () => {
      checklist.addItem({
        name: "Test XSS",
        category: TestCategory.INJECTION,
        priority: "high",
      });

      const items = checklist.getItems();
      checklist.markComplete(items[0]!.id, "No XSS found");

      const report = checklist.generateReport();
      expect(report.name).toBe("Q1 2026 Pen Test");
      expect(report.items).toHaveLength(1);
    });
  });
});
