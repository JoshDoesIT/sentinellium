/**
 * @module Pen Test Checklist
 * @description Penetration testing plan and checklist management.
 * Tracks test items, completion status, and generates reports.
 */

/* ── Types ── */

export enum TestCategory {
  AUTH = "authentication",
  SESSION = "session-management",
  INJECTION = "injection",
  CRYPTO = "cryptography",
  CONFIG = "configuration",
  DATA = "data-protection",
}

export type ItemStatus = "pending" | "in-progress" | "complete" | "skipped";

export interface PenTestItem {
  id: string;
  name: string;
  category: TestCategory;
  priority: "high" | "medium" | "low";
  status: ItemStatus;
  findings?: string;
  completedAt?: number;
}

export interface PenTestProgress {
  total: number;
  completed: number;
  percentage: number;
}

export interface PenTestReport {
  name: string;
  createdAt: number;
  items: PenTestItem[];
  progress: PenTestProgress;
}

/* ── Helpers ── */

let itemSeq = 0;
function generateItemId(): string {
  itemSeq++;
  return `PT-${itemSeq.toString().padStart(4, "0")}`;
}

/* ── Checklist ── */

/**
 * Penetration test checklist with progress tracking.
 */
export class PenTestChecklist {
  private readonly name: string;
  private readonly createdAt: number;
  private readonly items: PenTestItem[] = [];

  constructor(name: string) {
    this.name = name;
    this.createdAt = Date.now();
  }

  /**
   * Add a test item.
   *
   * @param input - Item details
   */
  addItem(input: {
    name: string;
    category: TestCategory;
    priority: "high" | "medium" | "low";
  }): void {
    this.items.push({
      id: generateItemId(),
      name: input.name,
      category: input.category,
      priority: input.priority,
      status: "pending",
    });
  }

  /**
   * Mark an item as complete.
   *
   * @param id - Item ID
   * @param findings - Test findings
   */
  markComplete(id: string, findings: string): void {
    const item = this.items.find((i) => i.id === id);
    if (!item) throw new Error(`Item '${id}' not found`);
    item.status = "complete";
    item.findings = findings;
    item.completedAt = Date.now();
  }

  /** Get all items. */
  getItems(): PenTestItem[] {
    return this.items.map((i) => ({ ...i }));
  }

  /** Get progress stats. */
  getProgress(): PenTestProgress {
    const total = this.items.length;
    const completed = this.items.filter((i) => i.status === "complete").length;
    return {
      total,
      completed,
      percentage: total > 0 ? Math.round((completed / total) * 100) : 0,
    };
  }

  /** Generate a summary report. */
  generateReport(): PenTestReport {
    return {
      name: this.name,
      createdAt: this.createdAt,
      items: this.getItems(),
      progress: this.getProgress(),
    };
  }
}
